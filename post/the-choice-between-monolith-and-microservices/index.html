<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>ä»‹äºä¼ ç»Ÿå·¨çŸ³æœåŠ¡ä¸å¾®æœåŠ¡ä¹‹é—´çš„ä¸€ç§é€‰æ‹© | a little bit</title>
<meta name="description" content="æˆ‘æ€æ•…æˆ‘åœ¨">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kswen.github.io/favicon.ico?v=1567321953869">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://kswen.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kswen.github.io">
        <img src="https://kswen.github.io/images/avatar.png?v=1567321953869" class="site-logo">
        <h1 class="site-title">a little bit</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      æˆ‘æ€æ•…æˆ‘åœ¨
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://kswen.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">ä»‹äºä¼ ç»Ÿå·¨çŸ³æœåŠ¡ä¸å¾®æœåŠ¡ä¹‹é—´çš„ä¸€ç§é€‰æ‹©</h2>
            <div class="post-date">2019-08-24</div>
            
              <div class="feature-container" style="background-image: url('https://kswen.github.io/post-images/the-choice-between-monolith-and-microservices.jpg')">
              </div>
            
            <div class="post-content">
              <h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>å…¬å¸æœ‰å¤§éƒ¨åˆ†å¼€å‘äººå‘˜ç¼ºä¹å»ç§¯æå­¦ä¹ æ–°æŠ€æœ¯æ–°çŸ¥è¯†çš„è¡ŒåŠ¨, ç”šè‡³äºå°±ç®—ç»™ä»–ä»¬åŸ¹è®­, ä»–ä»¬ä¹Ÿæ‡’å¾—å¬æˆ–è€…è§‰å¾—è‡ªå·±ä»€ä¹ˆéƒ½æ‡‚. æ‰€ä»¥è€ƒè™‘åˆ°å½“å‰å›¢é˜Ÿå’Œå…¬å¸è§„æ¨¡çš„ä¸€äº›å› ç´ ï¼Œåœ¨ç³»ç»Ÿæ¶æ„å‡çº§è¿‡ç¨‹ä¸­é€‰æ‹©äº†ä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œå…¼é¡¾ä¸Šä¸‹ï¼Œæ‰¾åˆ°éœ€æ±‚ä¸æŠ€æœ¯çš„å¹³è¡¡ç‚¹ã€‚</p>
<!-- more -->
<p>ä»¥æˆ‘ä»¬çš„ç»éªŒåˆ†æï¼ŒtomcatæœåŠ¡ä¸‹ä¼šéƒ¨ç½²ä¸€ä¸ªæˆ–å¤šä¸ªWebé¡¹ç›®ï¼Œå…·ä½“çœ‹é¡¹ç›®éœ€æ±‚ã€‚ä¸€ä¸ªé¡¹ç›®ä¸­ä¼šæ··æ‚ç€å„ç§åŠŸèƒ½æ¨¡å—çš„å®ç°ï¼Œæ¯ä¸ªåŠŸèƒ½æ¨¡å—çš„å®ç°å‡çº§æˆ–bugä¿®å¤éƒ½æ¶‰åŠåˆ°æœåŠ¡é‡å¯ï¼Œè™½ç„¶æœ‰nginxä½œä¸ºå‰ç½®ä»£ç†ï¼Œä½†å¤šå°‘è¿˜æ˜¯å½±å“åˆ°å®¢æˆ·çš„ä½“éªŒï¼Œè€Œä¸”ä¸€ä¸å°å¿ƒé‡å¤§bugå…¨çº¿å´©ç›˜...ğŸ˜‚</p>
<p>Spring bootçš„å‡ºç°ç»™æˆ‘ä»¬å¸¦æ¥å¼€å‘çš„ä¾¿åˆ©ç‚¹. å¼€å§‹ä¸€ä¸ªæ–°çš„é¡¹ç›®æ¨¡å—æ— éœ€å†å»æåŠå¤©é…ç½®, ç„¶åæ‰å¼€å§‹å†™è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘. åªéœ€æ‰“å¼€<a href="https://start.spring.io/">Spring Initializr</a>, ç®€å•çš„ç‚¹å‡ ä¸‹, æ‰“å¼€IDEå°±å¯ä»¥ç›´æ¥å¹²æ´»äº†. Springbootè‡ªå¸¦åµŒå…¥Tomcatçš„æ–¹å¼ä¹Ÿæ˜¯æå…¶é‡è¦çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹, æ‰“åŒ…jarç›´æ¥è¿è¡Œ,** Make jar not war**. ç›´æ¥ä¸ŠSpringCloudé‚£å¥—å›¢é˜Ÿè¦æŒæ¡çš„çŸ¥è¯†ç‚¹å¤ªå¤š, å¦‚æœåªæ˜¯å»æŒæ¡Springbootè¿™å¥—å¼€å‘æ¡†æ¶çš„è¯å­¦ä¹ æˆæœ¬è¦ä½å¾—å¤š, å¯ä»¥è¯´æ˜¯å¯¹ä¼ ç»Ÿå¼€å‘æ€ç»´æ¨¡å¼åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆå½±å“. å¤§æ¦‚å°±è¿™ä¹ˆä¸ªèƒŒæ™¯ä¿ƒæˆäº†è¿™ä¸ªé€‰æ‹©, ä¸‹é¢ç®€å•æè¿°ä¸€ä¸‹æ¶æ„é€»è¾‘, å¤§æ¦‚äº†è§£ä¹‹åå†å†³å®šè¦ä¸è¦ç»§ç»­è¯»ä¸‹å», é¿å…æµªè´¹ä½ çš„æ—¶é—´.</p>
<h2 id="æ¶æ„é€»è¾‘æ¦‚è§ˆ">æ¶æ„é€»è¾‘æ¦‚è§ˆ</h2>
<p><img src="https://kswen.github.io/post-images/1566734130509.png" alt="ç³»ç»Ÿæ•´ä½“æ¶æ„"><br>
ä»…çœ‹è¿™å›¾å¯èƒ½æ˜¯æ²¡æ³•çœ‹æ˜ç™½çš„, ç›¸å¯¹ç®€å•äº†ç‚¹. ä¸‹é¢ä»¥ä¸€ä¸ªå…·ä½“çš„è¯·æ±‚ä¾‹å­æ¥æè¿°.</p>
<p>ä»¥è¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯ä¸ºä¾‹, å¦‚ä¸‹:</p>
<pre><code>https://api.demo.com/mars/user/get?id=user001
</code></pre>
<p>å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰è¿™é‡ŒåŒ…å«çš„ä¿¡æ¯ç±»å‹, æˆ‘ä»¬å¤§æ¦‚æ‹†åˆ†æˆä»¥ä¸‹å‡ éƒ¨åˆ†:</p>
<ul>
<li>è¯·æ±‚æœåŠ¡åŸŸå: api.demo.com</li>
<li>æœåŠ¡åç§°: mars</li>
<li>è¯·æ±‚è·¯ç”±æ˜ å°„: /user/get</li>
<li>å‚æ•°: id=user001</li>
</ul>
<p>æˆ‘ä»¬è¦è·å–çš„ç”¨æˆ·ä¿¡æ¯åŒ…æ‹¬ä»¥ä¸‹å‡ å—:</p>
<ul>
<li>ç”¨æˆ·åŸºæœ¬ä¿¡æ¯(å§“å, ç”µè¯, åœ°å€.....)</li>
<li>é“¶è¡Œè´¦æˆ·ä¿¡æ¯(ä¿¡ç”¨å¡ä¿¡æ¯, å‚¨è“„å¡ä¿¡æ¯, å€Ÿè´·ä¿¡æ¯..)</li>
<li>ç”¨æˆ·å¼€é€šä¸šåŠ¡ä¿¡æ¯</li>
<li>æœ€è¿‘äº¤æ˜“ä¿¡æ¯</li>
<li>ç”¨æˆ·è´¦æˆ·å®¡è®¡ä¿¡æ¯</li>
<li>.....è¿˜æœ‰å…¶ä»–ä¿¡æ¯</li>
</ul>
<p>æˆ‘ä»¬ä¹‹å‰çš„åšæ³•æ˜¯é€šè¿‡åœ¨åŒä¸€ä¸ªå®ä¾‹é‡Œé¢çš„ä¸€ä¸ªå…¥å£æ–¹æ³•è¯·æ±‚ä¸åŒçš„å…¶ä»–æ¨¡å—æ–¹æ³•,  ç„¶åèšåˆè¿”å›å‰ç«¯æ‰€éœ€è¦çš„æ•°æ®. ä¸ç®¡æ€ä¹ˆåˆ†åŒ…, å…¶å®è¿˜æ˜¯åœ¨åŒä¸€ä¸ªJVMå®ä¾‹é‡Œé¢è¿è¡Œ.</p>
<p>ç°åœ¨åšæ³•æ˜¯æ ¹æ®åŠŸèƒ½æ¨¡å—æ‹†åˆ†æˆå¤šä¸ªæœåŠ¡, æ¯”å¦‚ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æ˜¯ä¸€ä¸ªå•ç‹¬çš„RESTæœåŠ¡(å•ç‹¬å¯ä»¥è¿è¡Œçš„jar), äº¤æ˜“ä¿¡æ¯åˆæ˜¯å¦å¤–ä¸€ä¸ª...</p>
<p>è¿™é‡Œå…¥å£æœåŠ¡ä¸ºmars, é‚£marsé‡Œé¢çš„ä¸€ä¸ªå…¥å£æ–¹æ³•ä¼šè¯·æ±‚ä¸åŒçš„æœåŠ¡RESTæ¥å£(å¤šæ¬¡ç½‘ç»œè¯·æ±‚, è¿™é‡Œé¢åˆå¯ä»¥æœ‰å¤šç§ç©æ³•), æˆ–è®¸ä½ ä¼šæ‹…å¿ƒå“åº”é€Ÿåº¦é—®é¢˜, å®é™…æµ‹è¯•å‘ç°æ˜¯æœ‰å½±å“çš„, ä½†æ˜¯è¿™ç‚¹å½±å“å¯¹äºäººç±»æ„ŸçŸ¥æ¥è¯´åŸºæœ¬å¯ä»¥å¿½ç•¥ä¸è®¡.</p>
<p>ä¸€ä¸ªå®ä¾‹çš„æœåŠ¡ä»¥REST APIçš„æ–¹å¼åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´å…±äº«, ä½†æ˜¯å®é™…å¹¶æ²¡æœ‰æœåŠ¡æ³¨å†Œä¸­å¿ƒ, é‚£ä¹ˆå½“éƒ¨ç½²å¤šä¸ªæœåŠ¡å®ä¾‹çš„æ—¶å€™æˆ–è€…æœåŠ¡å‘å¸ƒçš„æ—¶å€™æ€ä¹ˆå»ä¿è¯æœåŠ¡çš„å¯ç”¨? è¿™ä¸ªé—®é¢˜å¯ä»¥åœ¨<a href="https://konghq.com/">Kong</a>è¿™ä¸ªæŠ¥ç½‘å…³é‡Œå¾ˆå¥½çš„è§£å†³. å…³äºKongçš„ä»‹ç»è¿™é‡Œå°±ä¸å•°å—¦, å®˜æ–¹æ–‡æ¡£å¾ˆå®Œç¾, ç›´æ¥å»å®˜ç½‘çœ‹.  å¦‚æœä½ ä½¿ç”¨æˆ–äº†è§£è¿‡Nginx, çœ‹çœ‹è¿™ä¸ªå›¾å°±æ˜ç™½äº†.<br>
<img src="https://kswen.github.io/post-images/1566787847453.png" alt=""></p>
<h2 id="å®é™…è¡ŒåŠ¨">å®é™…è¡ŒåŠ¨</h2>
<p>è¯´å½’è¯´, å®é™…è¿˜å¾—è¡ŒåŠ¨èµ·æ¥æ‰çŸ¥é“è¡Œä¸è¡Œ.  è¿™å¥—ç»“æ„é‡Œé¢å¯çµæ´»å˜é€šçš„ä¸œè¥¿å¾ˆå¤š, ä¸æ–¹ä¾¿ä¸€ä¸€è§£é‡Šæè¿°, ä¸‹é¢ä»0å¼€å§‹ä»¥æˆ‘ä»¬å®é™…æƒ…å†µæ¥åšä¸ªdemo.</p>
<h3 id="ç½‘ç»œè§„åˆ’">ç½‘ç»œè§„åˆ’</h3>
<p>æ—¢ç„¶äº‘æœåŠ¡å™¨æ˜¯å¦‚æ­¤çš„æµè¡Œ, é‚£æˆ‘ä»¬å°±ä»¥äº‘æœåŠ¡å™¨æ¥å®ç°, å®é™…è‡ªå·±å»ç§ŸIDCæœºæŸœéƒ¨ç½²ä¹Ÿæ˜¯å¤§åŒå°å¼‚.  æ‰€æœ‰æœåŠ¡å™¨éƒ½åœ¨ä¸€ä¸ªVPCä¸‹, ä¸€å…±4å°ECS, ç½‘å…³æœåŠ¡å™¨ç»‘å®šå¼¹æ€§å…¬ç½‘IP, å¼€æ”¾httpsæœåŠ¡.</p>
<h4 id="ä¸€å°ç½‘å…³æœåŠ¡å™¨">ä¸€å°ç½‘å…³æœåŠ¡å™¨</h4>
<p>KongæœåŠ¡å®‰è£…åœ¨è¿™å°ä¸Šé¢, Kongçš„å®‰è£…è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£, å…¥å£é˜²ç«å¢™å¼€æ”¾443ç«¯å£æœåŠ¡.<br>
IPåœ°å€é…ç½®: 192.168.0.1 .</p>
<h4 id="ä¸€å°webæœåŠ¡å™¨">ä¸€å°WEBæœåŠ¡å™¨</h4>
<p>ç”¨äºéƒ¨ç½²å‰ç«¯æœåŠ¡, æ²¡ä»€ä¹ˆå®é™…ä¸šåŠ¡æ“ä½œ,  ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰©å±•å’Œä¸šåŠ¡æ•°æ®å®‰å…¨éš”ç¦», WEBæœåŠ¡å¯èƒ½ä¼šè¯·æ±‚åˆ°åç«¯çš„å¤šä¸ªServiceæœåŠ¡, èšåˆè¿”å›æ‰€éœ€æ•°æ®æ¨¡å‹.<br>
IPåœ°å€é…ç½®: 192.168.0.10</p>
<h4 id="ä¸€å°serviceæœåŠ¡å™¨">ä¸€å°ServiceæœåŠ¡å™¨</h4>
<p>ç”¨äºéƒ¨ç½²ServiceæœåŠ¡, æ•°æ®åŠ è§£å¯†, ä¸šåŠ¡é€»è¾‘å¤„ç†é›†ä¸­åœ¨è¿™é‡Œ, æ•°æ®åº“åŸºæœ¬ä¸Šå°±åªå……å½“æ•°æ®å­˜å‚¨çš„åŠŸèƒ½, æ²¡æœ‰Function, procedureè¿™äº›.<br>
IPåœ°å€é…ç½®: 192.168.0.20</p>
<h4 id="ä¸€å°æ•°æ®åº“æœåŠ¡å™¨">ä¸€å°æ•°æ®åº“æœåŠ¡å™¨</h4>
<p>è¿™ä¸ªæ²¡ä»€ä¹ˆç‰¹åˆ«çš„, å°±æ˜¯æ•°æ®å­˜å‚¨, æ»¡è¶³CRUD, æ ¹æ®ä¸šåŠ¡è§„æ¨¡åšå¥½è§„åˆ’.<br>
IPåœ°å€é…ç½®: 192.168.0.60</p>
<h3 id="æœåŠ¡å‘å¸ƒ">æœåŠ¡å‘å¸ƒ</h3>
<p>æŠŠåŸæ¥ä»…æœ‰çš„6ä¸ªæœåŠ¡æ‹†åˆ†æˆå¤šä¸ª, æ‹†åˆ†åå‰åç«¯æœåŠ¡åŠ èµ·æ¥æœ‰30ï¼‹, è¿™ä¹ˆå¤šä¸ªæœåŠ¡è¿˜è¦å¤šä¸ªå®ä¾‹éƒ¨ç½², æ‰‹å·¥æ“ä½œè‚¯å®šæ˜¯ä¸å¤ªç°å®çš„. æ‰€ä»¥JenkinsæŒç»­æ„å»ºå°±æ˜¾å¾—ååˆ†çš„é‡è¦.</p>
<h4 id="jenkinsç®¡é“å‘å¸ƒçš„åˆ›å»º">Jenkinsç®¡é“å‘å¸ƒçš„åˆ›å»º</h4>
<p>ä»¥å‰æƒ³åœ¨Jenkinså®ç°è‡ªåŠ¨å‘å¸ƒä¸€æ•´å¥—, éœ€è¦éœ€è¦æ’ä»¶çš„é…åˆ, å…ˆJenkinsæœ‰äº†pipelineçš„æ”¯æŒ, æ–°å»ºä¸€ä¸ªJobå’ŒJenkinsçš„äº¤äº’é…ç½®å‡å°‘äº†åŸºæœ¬ä¸Šä¸€æ­¥å®Œæˆ, å‰©ä½™çš„éƒ½é›†ä¸­å†Jenkinsfileçš„ç¼–å†™ä¸Š. å…³äºJenkinsfileè„šæœ¬çš„ç¼–å†™, è¯·å‚è€ƒå®˜æ–¹çš„<a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/">Jenkinsfileæ–‡æ¡£</a></p>
<p>Jenkinsfileçš„é‡Œæ”¯æŒGroovyåŸºæœ¬, è¿™å¾ˆå—ç¨‹åºçŒ¿çš„æ¬¢è¿, åªè¦å¯ä»¥å†™ä»£ç , æœ‰ä»€ä¹ˆä¸å¯èƒ½çš„, O(âˆ©_âˆ©)O~. è¿™é‡Œå®šä¹‰ä¸åŒçš„é˜¶æ®µå»å®ç°æ‰€éœ€çš„æ“ä½œ, é€šè¿‡Blue Ocean UIå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°æ•´ä¸ªæ„å»ºçš„è¿‡ç¨‹. e.g.<br>
<img src="https://kswen.github.io/post-images/1566790906222.png" alt="æ„å»ºè¿‡ç¨‹ç›´è§‚å±•ç°"></p>
<h4 id="jenkinsfileå…³é”®æ­¥éª¤">Jenkinsfileå…³é”®æ­¥éª¤</h4>
<p>åœ¨ç¼–å†™æ„å»ºè„šæœ¬æ–‡ä»¶æ—¶éœ€è¦å®ç°ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ç‚¹:</p>
<ol>
<li>æœåŠ¡æ„å»ºä¹‹å‰éœ€è¦å…ˆæ„å»ºç›¸åº”çš„ç»„ä»¶(jaræˆ–è€…é…ç½®æ–‡ä»¶ä¹‹ç±»çš„), ç»„ä»¶ç›´æ¥ä¼˜å…ˆå…³ç³»ä¹Ÿè¦å®šä¹‰æ¸…æ¥š.</li>
<li>æœåŠ¡å¤šå®ä¾‹éƒ¨ç½²åœ¨åŒä¸€å°æœºå­ä¸Šéœ€è¦çš„ç«¯å£å®šä¹‰.</li>
<li>æœåŠ¡å‘å¸ƒæ¨¡å¼: æ»šåŠ¨/é‡‘ä¸é›€(å…ˆå®šä¹‰åœ¨åŸºæœ¬é‡Œ, æ„å»ºæ—¶æ ¹æ®ç”¨æˆ·é€‰æ‹©æ‰§è¡Œ)</li>
<li>æœåŠ¡å‘å¸ƒå‰å…ˆå°†å½“å‰å¾…æ›¿æ¢çš„æœåŠ¡çŠ¶æ€è®¾ç½®ä¸ºæœåŠ¡ä¸å¯ç”¨(httpçŠ¶æ€ç 503)</li>
<li>æœåŠ¡å®ä¾‹å‘å¸ƒå®Œæˆ, å°†è¯¥å®ä¾‹æœåŠ¡çŠ¶æ€è®¾ç½®ä¸ºå¯ç”¨(httpçŠ¶æ€ç 200)</li>
<li>å½“å‰å®ä¾‹æˆåŠŸå‘å¸ƒ, ç»§ç»­ä¸‹ä¸€ä¸ªå®ä¾‹å‘å¸ƒ, å¤±è´¥æ ¹æ®ç­–ç•¥å›æ»š, è€…åœæ­¢æˆ–æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬.</li>
</ol>
<p>Jenkinsfile æ ·ä¾‹:</p>
<pre><code>pipeline {
    agent any
    
    parameters {
     	string(name: 'LAST_SUCC_VERSION', defaultValue: 'X', description: 'è¯·è¾“å…¥ä¸Šä¸€ä¸ªæ­£ç¡®å‘å¸ƒçš„ç‰ˆæœ¬(ä¸Šä¸€ä¸ªbuildé‡Œçš„Revision: xxxxx)ï¼Œé€‰æ‹©ã€æ»šåŠ¨å‘å¸ƒã€‘æ­¤é¡¹æ— æ•ˆ')
        choice(name: 'REQUESTED_NODE_ACTION', choices: ['2','4','6','8','10'], description: 'è¯·é€‰æ‹©åº”ç”¨éƒ¨ç½²èŠ‚ç‚¹ä¸ªæ•°')
        choice(name: 'DEPLOY_STRATEGY', choices: ['RollingUpdate','Canary'], description: 'è¯·é€‰æ‹©åº”ç”¨éƒ¨ç½²ç­–ç•¥ï¼š\n RollingUpdate: æ»šåŠ¨(ğŸ”)å‘å¸ƒ, ä¸­é€”ä¸ä¼šæš‚åœã€‚\n Canary: é‡‘ä¸é›€(ğŸ¦)å‘å¸ƒ, ä¸­é€”éœ€è¦äººå·¥å¹²é¢„ã€‚')
    }
    
    environment { 
        def M2_HOME = '/opt/devops/apps/maven/bin'
        
        def R_SSH_PORT = '22'
        
        def DEPLOY_NAME = 'mars-1.0.0.jar'
        
        def WEB_NODE_01 = 'rock-gateway-node-01'
        
        def WEB_NODE_02 = 'rock-gateway-node-02'
        
        def BUNDLE_PATH = '/opt/boot-cls/bundle'
        
        def BIN_PATH = '/opt/boot-cls/bin'
    }
    
    stages {
    	stage('Strategy') {
            steps {
                echo &quot;...Deploy ${params.REQUESTED_NODE_ACTION} Nodes Service With ${params.DEPLOY_STRATEGY} Strategy...&quot;;
                script{
                	if('Canary' == params.DEPLOY_STRATEGY){
                		echo &quot;...Recovery standby version is ${params.LAST_SUCC_VERSION}...&quot;;
                	}
                }
        	}
        }
        stage('PreBuild') {
            steps {
                echo '...Building Env Prepare...'
                build job: 'config-files', propagate: true
            }
        }
        stage('rock-sextans') {
            steps {
                echo '...Building IPay-Sextans...'
                build job: 'rock-sextans', propagate: true
            }
        }
        stage('Build') {
            steps {
                echo '...Building...'
                sh '${M2_HOME}/mvn clean install -U -Ppro'
                archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
            }
        }
        stage('Unit Tests') {
            steps {
                echo '...Unit Testing..'
            }
        }
        stage ('Deployment') {
        	steps {
        		script{
    				def deployNodes = ['10010', '10011', '10012', '10013', '10014', '10015', '10016', '10017', '10018', '10019']
    				def serviceName = &quot;mars&quot;
    				def nodeNumbers = params.REQUESTED_NODE_ACTION as Integer;
    				
    				echo &quot;...${nodeNumbers} Nodes to deploy&quot;
    				
    				if(nodeNumbers&gt;10){
    					error &quot;...Can not perform deploy action, root cause: exceed max node support&quot;
						currentBuild.result = 'FAILURE'
						sh &quot;exit 1&quot;
    				}
    				
                    for (int i = 0; i &lt; nodeNumbers; ++i) {
                    	
                    	showStartBuildMsg(&quot;${deployNodes[i]}&quot;);
                    	
                    	echo &quot;...Set ${serviceName}-${deployNodes[i]} service status to 503&quot;
                    	setNodeStatus(&quot;${WEB_NODE_01}&quot;, &quot;${deployNodes[i]}&quot;, &quot;${serviceName}&quot;)
                    	
                        echo &quot;...Deploying ${DEPLOY_NAME} on node ${WEB_NODE_01} use port ${deployNodes[i]}&quot;
                        deploy2Node(&quot;${WEB_NODE_01}&quot;,&quot;${serviceName}-${deployNodes[i]}-deploy.sh&quot;)
                        
                        echo &quot;...Check boot status&quot;
	                	bootStatus(&quot;${WEB_NODE_01}&quot;, &quot;${deployNodes[i]}&quot;, &quot;${serviceName}&quot;)
	                	
	                	echo &quot;...Check myStatus&quot;
	                	e2eStatus(&quot;${WEB_NODE_01}&quot;, &quot;${deployNodes[i]}&quot;, &quot;${serviceName}&quot;)
	                	
	                	showDeployStatus(&quot;${deployNodes[i]}&quot;, &quot;${serviceName}&quot;);
	                	
	                	echo &quot;...Deploying ${DEPLOY_NAME} on standby node ${WEB_NODE_02} with port ${deployNodes[i]}&quot;
                        deploy2StandByNode(&quot;${WEB_NODE_02}&quot;,&quot;${serviceName}-${deployNodes[i]}-standby.sh&quot;)
	                	
	                	showStandByNodeStatus(&quot;${WEB_NODE_02}&quot;, &quot;${deployNodes[i]}&quot;, &quot;${serviceName}&quot;);
	                	
	                	if('Canary' == params.DEPLOY_STRATEGY &amp;&amp; i &lt; nodeNumbers-1){
	                		
	                		def decisionDesc = '0- ç»§ç»­éƒ¨ç½²ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡;  1-åœæ­¢éƒ¨ç½²æ“ä½œï¼Œå¹¶åœæ­¢å½“å‰å·²éƒ¨ç½²èŠ‚ç‚¹æœåŠ¡;  ç»ˆæ­¢ï¼ˆAbortï¼‰æ“ä½œä¸ä¼šåœæ­¢å·²ç»éƒ¨ç½²å®Œæˆçš„èŠ‚ç‚¹æœåŠ¡';
	                		def optionsList = ['0','1'];
	                	
	                		if('X' != params.LAST_SUCC_VERSION){
	                			
	                			decisionDesc = '0- ç»§ç»­éƒ¨ç½²ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æœåŠ¡;  1-åœæ­¢éƒ¨ç½²æ“ä½œï¼Œå¹¶åœæ­¢å½“å‰å·²éƒ¨ç½²èŠ‚ç‚¹æœåŠ¡; 2-æ¢å¤åˆ°æ­£ç¡®ç‰ˆæœ¬: '+params.LAST_SUCC_VERSION+'; ç»ˆæ­¢ï¼ˆAbortï¼‰æ“ä½œä¸ä¼šåœæ­¢å·²ç»éƒ¨ç½²å®Œæˆçš„èŠ‚ç‚¹æœåŠ¡';
	                			optionsList = ['0','1','2'];
	                		}
	                	
	                		def userChoice = input(ok:'ç¡®è®¤', message: 'è¯·é€‰æ‹©ç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ?', parameters: [choice(name: 'MAKE_A_DECISION', choices: optionsList, description: decisionDesc)]);
			
				            if('1' == userChoice){
				            	
				            	stopMsg(&quot;${deployNodes[i]}&quot;)
				            	stopNodeService(&quot;${WEB_NODE_01}&quot;,&quot;${serviceName}-${deployNodes[i]}-ctr.sh&quot;)
				            	echo &quot;.......Stop current deployed version completed.........&quot;
				            	
			            		echo &quot;.......The build mission terminatedğŸ›‘ by user.........&quot;
				            	currentBuild.result = 'FAILURE'
								sh &quot;exit 1&quot;
				            }
				            
				            if('2' == userChoice){
				            	
				            	stopMsg(&quot;${deployNodes[i]}&quot;)
				            	stopNodeService(&quot;${WEB_NODE_01}&quot;,&quot;${serviceName}-${deployNodes[i]}-ctr.sh&quot;)
			            		echo &quot;.......Stop current deployed version completed.........&quot;
			            		
			            		recoverMsg(params.LAST_SUCC_VERSION)
			            		recoverNodeService(&quot;${WEB_NODE_01}&quot;,&quot;${serviceName}-${deployNodes[i]}-recover.sh&quot;, params.LAST_SUCC_VERSION)
			            		echo &quot;.......Recover to version &quot;+params.LAST_SUCC_VERSION+&quot; mission accomplished.........&quot;
			            		
				            	currentBuild.result = 'FAILURE'
								sh &quot;exit 1&quot;
				            }
	                	}
                    }
                }
            }
        }
        stage(&quot;Completion&quot;){
        	steps {
        		echo &quot;â­â­â­â­â­ Mission complete, everything goes smoothlyâ­â­â­â­â­&quot;
        	}
        }
    }
}

def showStartBuildMsg(nodePort){
	stage('Deploying '+ nodePort) {
		echo &quot;...Deploying ${nodePort} Node Service&quot;
	}
}

def stopMsg(nodePort){
	stage('Stop '+ nodePort) {
		echo &quot;...Stop ${nodePort} Node Service&quot;
	}
}

def recoverMsg(lastSuccssVersion){
	stage('Recover v'+ lastSuccssVersion) {
		echo &quot;...Recover v${lastSuccssVersion} Node Service&quot;
	}
}

def stopNodeService(nodeName, ctrScript){
	
	sh &quot;ssh -p$R_SSH_PORT devops@${nodeName} sh ${BIN_PATH}/${ctrScript} stop&quot;
	sleep time: 1, unit: 'SECONDS'
}

def showDeployStatus(nodePort, serviceName){

	stage(nodePort+' Deployed') {
		echo &quot;...${serviceName}-${nodePort} Deployed successfully...ğŸ¸&quot;
	}
}

def recoverNodeService(nodeName, recoveryScript, lastSuccVersion){
	
    sh &quot;ssh -p$R_SSH_PORT devops@${nodeName} sh ${BUNDLE_PATH}/${recoveryScript} recovery ${lastSuccVersion}&quot;
	sleep time: 35, unit: 'SECONDS'
}

def deploy2StandByNode(nodeName, standbyScript){
	
    sh &quot;ssh -p$R_SSH_PORT devops@${nodeName} sh ${BUNDLE_PATH}/${standbyScript} standby&quot;
	sleep time: 15, unit: 'SECONDS'
}

def showStandByNodeStatus(nodeName, nodePort, serviceName){

	stage(nodeName+' StandBy') {
		echo &quot;...${serviceName}-${nodePort} StandBy Deployed successfully...ğŸ¸&quot;
	}
}

def setNodeStatus(nodeName, nodePort, serviceName){
	
	try{
	    HEALTH_STATUS = sh(returnStdout: true, script: &quot;curl -s \&quot;http://${nodeName}:${nodePort}/${serviceName}/actuator/health\&quot; | jq -r \&quot;.status\&quot;&quot;).trim()
		if (HEALTH_STATUS != 'DOWN') {
			sh &quot;curl -s \&quot;http://${nodeName}:${nodePort}/${serviceName}/outOfService?key=IAMSURE\&quot;&quot;
			sleep time: 35, unit: 'SECONDS'
		}
		
		HEALTH_STATUS = sh(returnStdout: true, script: &quot;curl -s \&quot;http://${nodeName}:${nodePort}/${serviceName}/actuator/health\&quot; | jq -r \&quot;.status\&quot;&quot;).trim()
	    if (HEALTH_STATUS != 'DOWN') {
			error &quot;Set ${serviceName}-${nodePort} status failed: ${HEALTH_STATUS}&quot;
			currentBuild.result = 'FAILURE'
			sh &quot;exit 1&quot;
		}else{
			echo &quot;...Set ${serviceName}-${nodePort} status to 503 successfully&quot;
		}
		sleep time: 35, unit: 'SECONDS'
	}catch(exc){
		echo &quot;...${serviceName}-${nodePort} not start yet: &quot; + exc.toString()
	}
}

def deploy2Node(nodeName, deployScript){
	
    sh &quot;ssh -p$R_SSH_PORT devops@${nodeName} sh ${BUNDLE_PATH}/${deployScript} deploy&quot;
	sleep time: 35, unit: 'SECONDS'
}

def bootStatus(nodeName, nodePort, serviceName){

	stage('Boot '+nodePort) {
		HEALTH_STATUS = sh(returnStdout: true, script: &quot;curl -s \&quot;http://${nodeName}:${nodePort}/${serviceName}/actuator/health\&quot; | jq -r \&quot;.status\&quot;&quot;).trim()
	    if (HEALTH_STATUS != 'UP') {
			error &quot;ğŸ ${serviceName}-${nodePort} boot status is ${HEALTH_STATUS}&quot;
			currentBuild.result = 'FAILURE'
			sh &quot;exit 1&quot;
		}else{
			echo &quot;...${serviceName}-${nodePort} boot status UPğŸ¸&quot;
		}
	}
}

def e2eStatus(nodeName, nodePort, serviceName){

	stage('E2E '+nodePort) {
		HEALTH_STATUS = sh(returnStdout: true, script: &quot;curl -s http://${nodeName}:${nodePort}/${serviceName}/myStatus&quot;).trim()
	    if (HEALTH_STATUS != 'UP') {
			error &quot;ğŸ ${serviceName}-${nodePort} E2E status is ${HEALTH_STATUS}&quot;
			currentBuild.result = 'FAILURE'
			sh &quot;exit 1&quot;
		}else{
			echo &quot;...${serviceName}-${nodePort} E2E status UPğŸ¸&quot;
		}
	}
}
</code></pre>
<p>å…·ä½“æƒ…å†µæ ¹æ®å®é™…æƒ…å†µæ¥.</p>
<h2 id="è¿ç»´">è¿ç»´</h2>
<p>ç”±äºæ‹†åˆ†çš„æœåŠ¡æ¯”è¾ƒå¤š, çº¿ä¸Šbugå®šä½å¤æ‚é—®é¢˜éšä¹‹è€Œæ¥, é‚£å°±éœ€è¦æ”¶é›†log, è€Œä¸”å¤šä¸ªæœåŠ¡ä¹‹é—´çš„logè¦èƒ½è¿èµ·æ¥, å¯è¿½è¸ª, æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ELKä¸‰ä»¶å¥—. æ¯ä¸ªæœåŠ¡logæ ¼å¼åŠ ä¸Šè¿½è¸ªçš„ID. e.g:</p>
<pre><code>log4j.logging.format=%d{yyyy-MM-dd HH:mm:ss.SSS} - [%X{X-B3-TraceId:-}, %X{X-B3-SpanId:-}, %X{X-B3-ParentSpanId:-}, %X{X-Span-Export:-}, ${PID:-}] [%thread] %ex %-5level %logger [line: %line] -- %msg%n
</code></pre>
<p>è¿™æ ·æŸ¥bugçš„æ—¶å€™, åªè¦æœåŠ¡å†™äº†log, é‚£åœ¨<a href="https://www.elastic.co/products/kibana">kibana</a>é‡Œé¢æŸ¥è¯¢è·Ÿè¸ªèµ·æ¥è¿˜æ˜¯å¾ˆå¿«çš„.</p>
<h2 id="æ€»ç»“å…³é”®ç‚¹">æ€»ç»“å…³é”®ç‚¹</h2>
<ul>
<li>
<p>ä½¿ç”¨Springbootç»™å¼€å‘äººå‘˜å¸¦æ¥çš„ä¾¿åˆ©æ€§, just need make a simple jar, that`s it, no more complexity.</p>
</li>
<li>
<p>å……åˆ†åˆ©ç”¨Kongç½‘å…³æä¾›çš„åŠŸèƒ½, ä¸°å¯Œçš„æ’ä»¶, æœåŠ¡å¥åº·æ£€æŸ¥, æ–­è·¯å™¨.</p>
</li>
<li>
<p>å°½é‡ç¼–å†™è‡ªåŠ¨åŒ–çš„æ„å»ºå’Œæµ‹è¯•è„šæœ¬, Jenkinsfile</p>
</li>
</ul>
<p>å…³äºKongå¦‚ä½•åˆ›å»ºä¸€ä¸ªå¯ç”¨æœåŠ¡, å¯å‚è€ƒ<a href="https://kswen.github.io/post/create-service-with-kong/">ä½¿ç”¨Kongåˆ›å»ºæœåŠ¡4æ­¥æ›²</a></p>
<p>è¿™é‡Œä¹Ÿåªæ˜¯æŠ›ç –å¼•ç‰ç®€å•æè¿°äº†ä¸€ä¸‹ç›®å‰ä½¿ç”¨åˆ°çš„ä¸€äº›æ¡†æ¶æ¨¡å¼, å…·ä½“æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„éƒ½å¯ä»¥é—®æˆ‘, å¾®ä¿¡: rssbar, ç”¨äºæ‚äº‹å¤š, ä¸ä¸€å®šèƒ½é©¬ä¸Šå›å¤.</p>
<blockquote>
<p>å„ç§æ¶æ„æœåŠ¡æµè¡Œçš„ä»Šå¤©, ä¸ç®¡æ˜¯æ¡†æ¶ä¹Ÿå¥½æ¶æ„ä¹Ÿç½¢, é€‰æ‹©é€‚åˆè‡ªå·±çš„æ‰æ˜¯æœ€å¥½çš„.</p>
</blockquote>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kswen.github.io/tag/GZ_DOfDgN" class="tag">
                    ç½‘å…³
                  </a>
                
                  <a href="https://kswen.github.io/tag/nxHJiW3U6N" class="tag">
                    Nginx
                  </a>
                
                  <a href="https://kswen.github.io/tag/uoNfZ1eX9f" class="tag">
                    Kong
                  </a>
                
                  <a href="https://kswen.github.io/tag/a1AsjYHDc" class="tag">
                    å¾®æœåŠ¡
                  </a>
                
                  <a href="https://kswen.github.io/tag/I0FCkQz2yX" class="tag">
                    springboot
                  </a>
                
                  <a href="https://kswen.github.io/tag/3nOH_8vczw" class="tag">
                    tomcat
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://kswen.github.io/post/you-looks-exhausted">
                  <h3 class="post-title">
                    oh, No~ ä½ çœ‹èµ·æ¥å¾ˆæ²¡æœ‰ç²¾ç¥å“¦ğŸ˜
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'dd83521c2ebf5816a7ab',
        clientSecret: 'd5ac3312e61ec22c616fb10f09c2694d2cb6bd11',
        repo: 'kswen.github.io',
        owner: 'kswen',
        admin: ['kswen'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
